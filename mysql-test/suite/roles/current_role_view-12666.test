CREATE USER has_role@'localhost';
GRANT ALL PRIVILEGES ON *.* TO has_role@'localhost';

CREATE ROLE test_role;
GRANT test_role TO has_role@'localhost';

CREATE USER no_role@'localhost';
GRANT ALL PRIVILEGES ON *.* TO no_role@'localhost';

CREATE TABLE view_role_test (
        id int primary key,
        role_name varchar(50)
        );

INSERT INTO view_role_test VALUES (1, 'test_role');


CREATE OR REPLACE 
DEFINER = no_role@localhost
SQL SECURITY INVOKER
VIEW v_view_role_test
AS
SELECT * FROM view_role_test WHERE role_name = CURRENT_ROLE();

show create view v_view_role_test;

SET ROLE test_role;

CREATE OR REPLACE 
DEFINER = no_role@localhost
SQL SECURITY INVOKER
VIEW v_view_role_test_2
AS
SELECT * FROM view_role_test WHERE role_name = CURRENT_ROLE();

show create view v_view_role_test_2;


SELECT CURRENT_USER();
SELECT CURRENT_ROLE();

SELECT * FROM view_role_test WHERE role_name = CURRENT_ROLE();
SELECT * FROM v_view_role_test;


drop user has_role@'localhost';
drop user no_role@'localhost';
drop role test_role;

drop table view_role_test;
drop view v_view_role_test;
drop view v_view_role_test_2;
